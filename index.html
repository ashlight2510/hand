<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì†ê¸ˆ ìŠ¤ìºë„ˆ | Palm Sense</title>
  <meta name="description" content="ì‚¬ì§„ë§Œ ì˜¬ë¦¬ë©´ 3ì´ˆ ë§Œì— ì†ê¸ˆ ì„±í–¥ì„ ì•Œë ¤ì£¼ëŠ” ê°€ë²¼ìš´ ì›¹ í…ŒìŠ¤íŠ¸">
  <meta property="og:title" content="ì†ê¸ˆ ìŠ¤ìºë„ˆ | Palm Sense">
  <meta property="og:description" content="ì‚¬ì§„ ì—…ë¡œë“œ â†’ 3ì´ˆ ë¶„ì„ â†’ ë‹¹ì‹  ì†ê¸ˆì˜ íë¦„ì„ ì¹´ë“œë¡œ ì „ë‹¬">
  <meta property="og:image" content="https://images.unsplash.com/photo-1504274066651-8d31a536b11a?auto=format&fit=crop&w=800&q=80">
  <meta name="theme-color" content="#111217">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Fraunces:opsz@9..144&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0c0d12;
      --panel: rgba(19, 20, 28, 0.75);
      --accent: #8df7b5;
      --accent-2: #f7e88d;
      --muted: #a6acbc;
      --text: #f6f7fb;
      --shadow: 0 10px 60px rgba(0, 0, 0, 0.45);
      --radius: 18px;
      --blur: saturate(120%) blur(18px);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Space Grotesk', 'Pretendard', system-ui, -apple-system, sans-serif;
      background: radial-gradient(120% 120% at 15% 15%, rgba(141, 247, 181, 0.08), transparent),
                  radial-gradient(120% 120% at 85% 25%, rgba(247, 232, 141, 0.07), transparent),
                  linear-gradient(145deg, #0c0d12 0%, #0d1118 55%, #0b0d12 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 32px 18px 60px;
    }
    .shell {
      width: min(1080px, 100%);
      background: var(--panel);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 28px;
      padding: 28px clamp(18px, 3vw, 32px) 34px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    .shell::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(65% 70% at 20% 0%, rgba(141, 247, 181, 0.08), transparent),
                  radial-gradient(75% 80% at 80% 10%, rgba(247, 232, 141, 0.08), transparent);
      pointer-events: none;
      z-index: 0;
    }
    header {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 26px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo span {
      font-weight: 700;
      letter-spacing: -0.5px;
      font-size: 20px;
    }
    .badge {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(141, 247, 181, 0.12);
      color: var(--accent);
      font-size: 13px;
      border: 1px solid rgba(141, 247, 181, 0.32);
    }
    h1 {
      margin: 0;
      font-size: clamp(26px, 5vw, 40px);
      line-height: 1.1;
      letter-spacing: -0.6px;
      font-family: 'Fraunces', 'Space Grotesk', serif;
    }
    .sub {
      margin: 10px 0 0;
      color: var(--muted);
      font-size: 15px;
    }
    .grid {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 22px;
    }
    .panel {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--blur);
    }
    .uploader {
      border: 1.3px dashed rgba(255, 255, 255, 0.18);
      border-radius: var(--radius);
      padding: 18px;
      min-height: 220px;
      display: grid;
      gap: 10px;
      align-content: center;
      justify-items: center;
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
    }
    .uploader:hover {
      border-color: rgba(141, 247, 181, 0.4);
      background: rgba(141, 247, 181, 0.02);
    }
    .uploader.dragover {
      border-color: var(--accent);
      background: rgba(141, 247, 181, 0.05);
    }
    .uploader input {
      display: none;
    }
    .hint {
      color: var(--muted);
      font-size: 13px;
      text-align: center;
    }
    .cta {
      background: linear-gradient(135deg, var(--accent), #9ef7e5);
      color: #0b0d12;
      border: none;
      border-radius: 12px;
      padding: 12px 18px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 40px rgba(141, 247, 181, 0.35);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .cta:hover { transform: translateY(-1px); box-shadow: 0 12px 40px rgba(141, 247, 181, 0.45); }
    .cta:active { transform: translateY(0); }
    .preview {
      width: 100%;
      border-radius: 12px;
      object-fit: cover;
      background: #111318;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }
    .hidden { display: none !important; }
    .loading {
      display: grid;
      gap: 10px;
      justify-items: center;
      text-align: center;
    }
    .loader {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 2px solid rgba(141, 247, 181, 0.2);
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
    }
    .loading p { margin: 0; color: var(--muted); }
    @keyframes spin { to { transform: rotate(360deg); } }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .card {
      padding: 14px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      display: grid;
      gap: 6px;
    }
    .card h3 {
      margin: 0;
      font-size: 15px;
      letter-spacing: -0.2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .pill {
      font-size: 12px;
      color: #0b0d12;
      background: var(--accent-2);
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 700;
    }
    .card p {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }
    .meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .chip {
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--muted);
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .share {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 16px;
    }
    .ghost {
      background: transparent;
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.16);
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
    }
    .ghost:hover {
      border-color: var(--accent);
      background: rgba(141, 247, 181, 0.05);
    }
    footer {
      margin-top: 20px;
      color: var(--muted);
      font-size: 12px;
      text-align: center;
    }
    .tips {
      display: grid;
      gap: 10px;
    }
    .tips strong { color: var(--text); }
    .alert {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 99, 99, 0.08);
      border: 1px solid rgba(255, 99, 99, 0.2);
      color: #ffb3b3;
      font-size: 13px;
    }
    .ok {
      background: rgba(141, 247, 181, 0.08);
      border-color: rgba(141, 247, 181, 0.2);
      color: var(--accent);
    }
    @media (max-width: 640px) {
      header { flex-direction: column; align-items: flex-start; }
      .shell { padding: 22px 16px 28px; }
      .uploader { min-height: 180px; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="logo">
        <span>âœ‹ Palm Sense</span>
        <span class="badge">ì›¹Â·ì¦‰ì‹œ ë¶„ì„</span>
      </div>
      <div class="hint">ì†ë°”ë‹¥ ì‚¬ì§„ì„ ì˜¬ë¦¬ë©´ 3ì´ˆ ì•ˆì— ì„±í–¥ ì¹´ë“œ ìƒì„±</div>
    </header>

    <section class="panel">
      <h1>ì‚¬ì§„ í•œ ì¥ìœ¼ë¡œ ë³´ëŠ” ì†ê¸ˆ íë¦„</h1>
      <p class="sub">ì„œë²„Â·ë”¥ëŸ¬ë‹ ì—†ì´ ì‘ë™í•˜ëŠ” ì´ˆê°„ë‹¨ MVP. ì—…ë¡œë“œ â†’ ì—°ì¶œ â†’ í•´ì„ ì¹´ë“œê¹Œì§€ í•œ ë²ˆì—.</p>
    </section>

    <div class="grid" style="margin-top: 18px;">
      <section class="panel">
        <label class="uploader" id="dropZone">
          <input type="file" accept="image/*" id="palmInput">
          <div style="font-size: 38px;">ğŸ“¤</div>
          <div>ì†ë°”ë‹¥ ì‚¬ì§„ì„ ëŒì–´ë†“ê±°ë‚˜ íƒ­í•´ì„œ ì—…ë¡œë“œ</div>
          <div class="hint">ì¹´ë©”ë¼ë„ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥ Â· JPG/PNG ê¶Œì¥</div>
          <button class="cta" type="button" id="triggerUpload">ì‚¬ì§„ ì„ íƒ</button>
        </label>
        <div id="previewArea" class="hidden">
          <p class="hint">ì—…ë¡œë“œí•œ ì‚¬ì§„</p>
          <img id="preview" class="preview" alt="ì†ë°”ë‹¥ ë¯¸ë¦¬ë³´ê¸°">
          <div id="detectMsg" class="alert hidden"></div>
        </div>
      </section>

      <section class="panel">
        <div id="idleCopy">
          <h3 style="margin: 0 0 8px;">ì–´ë–»ê²Œ ì‘ë™í•˜ë‚˜ìš”?</h3>
          <div class="tips">
            <div><strong>1.</strong> ì‚¬ì§„ì„ ì˜¬ë¦¬ë©´ ë©”íƒ€ë°ì´í„°(ë¹„ìœ¨Â·ë°ê¸°Â·í¬ê¸°)ë¥¼ ì½ìŠµë‹ˆë‹¤.</div>
            <div><strong>2.</strong> 2~3ì´ˆì˜ ë¶„ì„ ì—°ì¶œë¡œ ì‹ ë¢°ê°ì„ ìŒ“ìŠµë‹ˆë‹¤.</div>
            <div><strong>3.</strong> ë©”íƒ€ ì •ë³´ì— ë§ì¶˜ ì†ê¸ˆ í•´ì„ ì¹´ë“œë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.</div>
          </div>
        </div>
        <div id="loading" class="loading hidden">
          <div class="loader"></div>
          <p id="loadingText">ì†ê¸ˆ ì„ ì„ ì½ëŠ” ì¤‘...</p>
          <p class="hint" id="loadingHint">ë‹¹ì‹ ì˜ ì¸ìƒ íë¦„ì„ ì •ë¦¬í•˜ê³  ìˆì–´ìš”</p>
        </div>
        <div id="result" class="hidden">
          <div class="meta" id="metaChips"></div>
          <div class="cards" id="cards"></div>
          <div class="share">
            <button class="cta" type="button" id="shareBtn">ê²°ê³¼ ê³µìœ </button>
            <button class="ghost" type="button" id="copyBtn">ë§í¬ ë³µì‚¬</button>
            <span class="hint" id="shareStatus"></span>
          </div>
        </div>
      </section>
    </div>

    <footer>ë³¸ í…ŒìŠ¤íŠ¸ëŠ” ì‹¬ë¦¬ ê¸°ë°˜ ì—”í„°í…Œì¸ë¨¼íŠ¸ MVPì…ë‹ˆë‹¤. ì—…ë¡œë“œëœ ì‚¬ì§„ì€ ë¸Œë¼ìš°ì € ë‚´ì—ì„œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.</footer>
  </div>

  <script type="module">
    import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

    const input = document.getElementById('palmInput');
    const dropZone = document.getElementById('dropZone');
    const triggerUpload = document.getElementById('triggerUpload');
    const preview = document.getElementById('preview');
    const previewArea = document.getElementById('previewArea');
    const detectMsg = document.getElementById('detectMsg');
    const loading = document.getElementById('loading');
    const loadingText = document.getElementById('loadingText');
    const loadingHint = document.getElementById('loadingHint');
    const result = document.getElementById('result');
    const idleCopy = document.getElementById('idleCopy');
    const cards = document.getElementById('cards');
    const metaChips = document.getElementById('metaChips');
    const shareBtn = document.getElementById('shareBtn');
    const copyBtn = document.getElementById('copyBtn');
    const shareStatus = document.getElementById('shareStatus');

    const states = ['ì†ê¸ˆ ì„ ì„ ì½ëŠ” ì¤‘...', 'ë¯¸ì„¸í•œ êµ´ê³¡ì„ í•´ì„ ì¤‘...', 'ë‹¹ì‹ ë§Œì˜ íë¦„ì„ ì¡°ìœ¨ ì¤‘...'];
    const hints = ['ë‹¹ì‹ ì˜ ì¸ìƒ íë¦„ì„ ì •ë¦¬í•˜ê³  ìˆì–´ìš”', 'ìƒê°ë³´ë‹¤ ë‹¹ì‹ ì€ ì„¬ì„¸í•œ íƒ€ì…ì´ë„¤ìš”', 'ì—ë„ˆì§€ ë°©í–¥ì„ ë§¤ì¹­í•˜ê³  ìˆì–´ìš”'];

    let handLandmarker = null;
    let handInitPromise = null;
    async function initHand() {
      if (handInitPromise) return handInitPromise;
      handInitPromise = (async () => {
        if (!detectMsg) return;
        detectMsg.classList.remove('hidden');
        detectMsg.textContent = 'ì† ì¸ì‹ ëª¨ë¸ ë¡œë”© ì¤‘...';
        try {
          const fileset = await FilesetResolver.forVisionTasks(
            'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm'
          );
          handLandmarker = await HandLandmarker.createFromOptions(fileset, {
            baseOptions: {
              modelAssetPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm/hand_landmarker.task'
            },
            runningMode: 'IMAGE',
            numHands: 1,
            minHandDetectionConfidence: 0.15,
            minHandPresenceConfidence: 0.15
          });
          detectMsg.classList.add('hidden');
        } catch (err) {
          handLandmarker = null;
          detectMsg.textContent = 'ì† ì¸ì‹ ì´ˆê¸°í™” ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        }
      })();
      return handInitPromise;
    }
    initHand();

    const insightBank = {
      flow: [
        { tag: 'ì—ë„ˆì§€ íë¦„', text: 'ì´ˆë°˜ë³´ë‹¤ ì¤‘í›„ë°˜ì´ ë” ê°•í•œ ìƒìŠ¹í˜• ê³¡ì„ . ê¾¸ì¤€íˆ ìŒ“ì•„ì˜¬ë¦´ìˆ˜ë¡ í˜ì´ ë¶™ìŠµë‹ˆë‹¤.' },
        { tag: 'ì—ë„ˆì§€ íë¦„', text: 'ì§§ê³  êµµê²Œ ëª°ì…í•˜ëŠ” ë‹¨ê¸° í­ë°œí˜•. íƒ€ì´ë°ì„ ì¡ìœ¼ë©´ í° ë°˜ì „ì„ ë§Œë“­ë‹ˆë‹¤.' },
        { tag: 'ì—ë„ˆì§€ íë¦„', text: 'ì™„ë§Œí•˜ì§€ë§Œ ì•ˆì •ì ì¸ íŒŒë™. ì£¼ë³€ì´ í”ë“¤ë ¤ë„ ë‚´ í˜ì´ìŠ¤ë¥¼ ì§€í‚¤ëŠ” í¸ì…ë‹ˆë‹¤.' }
      ],
      mind: [
        { tag: 'ì‚¬ê³  ë°©ì‹', text: 'ë…ë¦½ì ì¸ íŒë‹¨ì„ ì„ í˜¸í•©ë‹ˆë‹¤. ê¸°ì¤€ì´ ëª…í™•í•´ íŒ€ì—ì„œë„ ë°©í–¥í‚¤ ì—­í• ì„ í•©ë‹ˆë‹¤.' },
        { tag: 'ì‚¬ê³  ë°©ì‹', text: 'ìƒìƒë ¥ì´ ê°•í•´ ìƒˆë¡œìš´ ì—°ê²°ì„ ì˜ ì°¾ìŠµë‹ˆë‹¤. ê¸°íšÂ·ì°½ì‘ì—ì„œ ê°•ì ì„ ë³´ì…ë‹ˆë‹¤.' },
        { tag: 'ì‚¬ê³  ë°©ì‹', text: 'ë°ì´í„°ì™€ ê°ê°ì„ ë™ì‹œì— ë³´ëŠ” í•˜ì´ë¸Œë¦¬ë“œí˜•. ë¦¬ìŠ¤í¬ë¥¼ ì¡°ìœ¨í•˜ëŠ” ë° ëŠ¥í•©ë‹ˆë‹¤.' }
      ],
      bond: [
        { tag: 'ê´€ê³„ ì„±í–¥', text: 'ê¹Šì´ ìˆëŠ” ì†Œìˆ˜ì™€ ì¹œë°€ë„ë¥¼ ë†’ì´ëŠ” íƒ€ì…. ì‹ ë¢°ë¥¼ ìŒ“ì„ìˆ˜ë¡ ì‹œë„ˆì§€ê°€ ë‚©ë‹ˆë‹¤.' },
        { tag: 'ê´€ê³„ ì„±í–¥', text: 'ë‹¤ì–‘í•œ ì¸ë§¥ì„ ê°€ë³ê²Œ ì—°ê²°í•˜ë©° ê¸°íšŒë¥¼ ë§Œë“­ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí‚¹ì— ìœ ë¦¬í•©ë‹ˆë‹¤.' },
        { tag: 'ê´€ê³„ ì„±í–¥', text: 'ê´€ê³„ì—ì„œ ì£¼ë„ì ìœ¼ë¡œ íë¦„ì„ ë§Œë“¤ê³ , ê°ˆë“±ì„ ì¤‘ì¬í•˜ëŠ” ë° ê°•ì ì´ ìˆìŠµë‹ˆë‹¤.' }
      ],
      work: [
        { tag: 'ì¼Â·ê¸ˆì „ìš´', text: 'ì ì€ ë³€ë™í­ìœ¼ë¡œë„ ê¾¸ì¤€íˆ ìŒ“ì•„ê°€ëŠ” ìŠ¤íƒ€ì¼. ë³µë¦¬ íš¨ê³¼ê°€ í¬ê²Œ ì‘ë™í•©ë‹ˆë‹¤.' },
        { tag: 'ì¼Â·ê¸ˆì „ìš´', text: 'ë‹¨ê¸° ìŠ¹ë¶€ì— ê°•í•©ë‹ˆë‹¤. ì¤‘ìš”í•œ ìˆœê°„ì— ì—ë„ˆì§€ë¥¼ ì§‘ì¤‘í•˜ë©´ í° ë³´ìƒì„ ì–»ìŠµë‹ˆë‹¤.' },
        { tag: 'ì¼Â·ê¸ˆì „ìš´', text: 'ìƒˆë¡œìš´ ì‹œì¥ì„ íƒìƒ‰í•˜ë©° ìˆ˜ìµì„ ë‹¤ë³€í™”í•˜ëŠ” í¸. íŠ¸ë Œë“œ ê°ë„ê°€ ë†’ìŠµë‹ˆë‹¤.' }
      ],
      bonus: [
        { tag: 'ì§‘ì¤‘ë„', text: 'ì†ë°”ë‹¥ì´ ë„“ì–´ ì§‘ì¤‘ì„ ì˜¤ë˜ ìœ ì§€í•©ë‹ˆë‹¤. í° ê·¸ë¦¼ì„ ê·¸ë¦´ ë•Œ ë¹›ë‚©ë‹ˆë‹¤.' },
        { tag: 'ì§‘ì¤‘ë„', text: 'ë‚ ë µí•œ ì†ë°”ë‹¥ ë¹„ìœ¨ë¡œ ë¹ ë¥¸ ê²°ë‹¨ì´ íŠ¹ì§•ì…ë‹ˆë‹¤. ìŠ¤íƒ€íŠ¸ì—…í˜• ê¸°ì§ˆ.' },
        { tag: 'ë°ê¸°', text: 'ë”°ëœ»í•œ ë°ê¸°ë¡œ ì£¼ë³€ì„ í¸ì•ˆí•˜ê²Œ ë§Œë“­ë‹ˆë‹¤. í˜‘ì—… ì‹œ ë¶„ìœ„ê¸° ë©”ì´ì»¤ ì—­í• .' },
        { tag: 'ë°ê¸°', text: 'ì°¨ë¶„í•œ í†¤ìœ¼ë¡œ ê¹Šì´ ìˆëŠ” í†µì°°ì„ ì„ í˜¸í•©ë‹ˆë‹¤. ë¶„ì„ê³¼ ì „ëµì— ê°•ì .' },
        { tag: 'ë””í…Œì¼', text: 'íŒŒì¼ í¬ê¸°ê°€ ì»¤ ì„¸ë¶€ ë””í…Œì¼ì„ ì¤‘ì‹œí•˜ëŠ” í¸. ì™„ì„±ë„ë¥¼ ì¤‘ìš”ì‹œí•©ë‹ˆë‹¤.' },
        { tag: 'ë””í…Œì¼', text: 'ê°€ë²¼ìš´ íŒŒì¼ì²˜ëŸ¼ ë¹ ë¥¸ ì‹¤í–‰ì´ ì¥ì . ìš°ì„  ì‹œì‘í•˜ê³  ê°œì„ í•˜ëŠ” ìŠ¤íƒ€ì¼.' }
      ]
    };

    const pick = list => list[Math.floor(Math.random() * list.length)];

    function extractMeta(img, file) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      ctx.drawImage(img, 0, 0);
      const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

      // Sample every 40th pixel for quick brightness estimation.
      let sum = 0;
      for (let i = 0; i < data.length; i += 4 * 40) {
        sum += (data[i] + data[i + 1] + data[i + 2]) / 3;
      }
      const avgBrightness = Math.round(sum / (data.length / (4 * 40)));
      const aspect = img.naturalWidth / img.naturalHeight;
      const sizeKB = Math.round((file.size / 1024) * 10) / 10;
      return { brightness: avgBrightness, aspect, sizeKB };
    }

    // Very lightweight skin-likeness heuristic as a fallback: checks sampled pixels for skin-like RGB ranges.
    function looksLikePalm(img) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      ctx.drawImage(img, 0, 0);
      const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
      let skinish = 0;
      let total = 0;
      for (let i = 0; i < data.length; i += 4 * 20) {
        const r = data[i], g = data[i + 1], b = data[i + 2];
        if (r > 80 && g > 40 && b > 20 && r > g && r > b && Math.abs(r - g) > 5 && (r - b) > 10) {
          skinish += 1;
        }
        total += 1;
      }
      const ratio = skinish / total;
      return ratio > 0.15; // loose threshold; catches palms even with missing fingers.
    }

    function generateInsights(meta) {
      const list = [];
      list.push(pick(insightBank.flow));
      list.push(pick(insightBank.mind));
      list.push(pick(insightBank.bond));
      list.push(pick(insightBank.work));

      // Meta-based spice to make it feel personal.
      if (meta.aspect > 1.1) list.push(insightBank.bonus[0]); // wide
      else if (meta.aspect < 0.9) list.push(insightBank.bonus[1]); // tall
      if (meta.brightness > 145) list.push(insightBank.bonus[2]);
      else list.push(insightBank.bonus[3]);
      if (meta.sizeKB > 1200) list.push(insightBank.bonus[4]);
      else list.push(insightBank.bonus[5]);
      return list;
    }

    function renderResult(meta, insights) {
      metaChips.innerHTML = '';
      const chipData = [
        `ë¹„ìœ¨: ${meta.aspect.toFixed(2)}:1`,
        `ë°ê¸°: ${meta.brightness}`,
        `íŒŒì¼: ${meta.sizeKB}KB`
      ];
      chipData.forEach(text => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = text;
        metaChips.appendChild(chip);
      });

      cards.innerHTML = '';
      insights.forEach((insight, idx) => {
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <h3><span class="pill">${insight.tag}</span> ì¹´ë“œ #${idx + 1}</h3>
          <p>${insight.text}</p>
        `;
        cards.appendChild(el);
      });
    }

    function setLoadingState(isLoading) {
      loading.classList.toggle('hidden', !isLoading);
      idleCopy.classList.toggle('hidden', isLoading);
      result.classList.add('hidden');
    }

    async function handleFile(file) {
      if (!file) return;
      await initHand(); // Ensure the model is loaded (or failed) before proceeding.
      const objectURL = URL.createObjectURL(file);
      preview.src = objectURL;
      previewArea.classList.remove('hidden');
      setLoadingState(true);

      let tick = 0;
      const interval = setInterval(() => {
        loadingText.textContent = states[tick % states.length];
        loadingHint.textContent = hints[tick % hints.length];
        tick += 1;
      }, 700);

      const img = new Image();
      img.onload = async () => {
        // If the model failed to init, allow users to know and stop gracefully.
        if (!handLandmarker) {
          clearInterval(interval);
          setLoadingState(false);
          detectMsg.className = 'alert';
          detectMsg.classList.remove('hidden');
          detectMsg.textContent = 'ì† ì¸ì‹ ëª¨ë¸ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
          return;
        }

        let handDetected = false;
        try {
          const detection = handLandmarker.detect(img);
          handDetected = Boolean(detection?.landmarks?.length);
        } catch (err) {
          handDetected = false;
        }
        // Retry once with flipped image to help awkward angles.
        if (!handDetected) {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          ctx.translate(canvas.width, 0);
          ctx.scale(-1, 1);
          ctx.drawImage(img, 0, 0);
          const flipped = new Image();
          flipped.src = canvas.toDataURL();
          await flipped.decode();
          try {
            const detection2 = handLandmarker.detect(flipped);
            handDetected = Boolean(detection2?.landmarks?.length);
          } catch (err) {
            handDetected = false;
          }
        }

        // Final fallback: allow palm-like textures even if fingers are partially missing.
        if (!handDetected) {
          handDetected = looksLikePalm(img);
        }

        if (!handDetected) {
          clearInterval(interval);
          setLoadingState(false);
          detectMsg.className = 'alert';
          detectMsg.classList.remove('hidden');
          detectMsg.textContent = 'ì†ë°”ë‹¥ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ì–´ìš”. ì†ë°”ë‹¥ ë©´ì´ ë” í¬ê²Œ, ë°°ê²½ ëŒ€ë¹„ë¥¼ ë†’ì—¬ ë‹¤ì‹œ ì´¬ì˜í•´ì£¼ì„¸ìš”.';
          return;
        }

        detectMsg.className = 'alert ok';
        detectMsg.classList.remove('hidden');
        detectMsg.textContent = 'ì†ë°”ë‹¥ ê°ì§€ ì™„ë£Œ! ê°œì¸í™” í•´ì„ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.';

        const meta = extractMeta(img, file);
        setTimeout(() => {
          clearInterval(interval);
          setLoadingState(false);
          const insights = generateInsights(meta);
          renderResult(meta, insights);
          result.classList.remove('hidden');
          shareStatus.textContent = '';
          URL.revokeObjectURL(objectURL);
        }, 2100);
      };
      img.src = objectURL;
    }

    triggerUpload.addEventListener('click', () => input.click());
    input.addEventListener('change', e => handleFile(e.target.files[0]));

    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      handleFile(e.dataTransfer.files[0]);
    });

    shareBtn.addEventListener('click', async () => {
      const text = 'ë‚´ ì†ê¸ˆ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ í™•ì¸í•´ë´ìš”';
      try {
        if (navigator.share) {
          await navigator.share({ title: 'ì†ê¸ˆ ìŠ¤ìºë„ˆ', text, url: location.href });
          shareStatus.textContent = 'ê³µìœ  ì™„ë£Œ!';
        } else {
          await navigator.clipboard.writeText(location.href);
          shareStatus.textContent = 'ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”.';
        }
      } catch (err) {
        shareStatus.textContent = 'ê³µìœ ê°€ ì·¨ì†Œëì–´ìš”.';
      }
    });

    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(location.href);
        shareStatus.textContent = 'ë§í¬ ë³µì‚¬ ì™„ë£Œ';
      } catch (err) {
        shareStatus.textContent = 'ë³µì‚¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
      }
    });
  </script>
</body>
</html>
